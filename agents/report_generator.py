"""
DeliverableEstimate Pro - Report Generator Agent
"""

import pandas as pd
import os
from datetime import datetime
from typing import Dict, List, Any
from pathlib import Path

from config.settings import settings


class ReportGenerator:
    """è¦‹ç©æ›¸å‡ºåŠ›ãƒ»æ‰¿èªç®¡ç†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"""
    
    def __init__(self):
        self.settings = settings
        self.output_dir = Path("output")
        self.output_dir.mkdir(exist_ok=True)
    
    def process(self, state: Dict[str, Any]) -> Dict[str, Any]:
        """è¦‹ç©æ›¸è¡¨ç¤ºã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªå‡¦ç†"""
        try:
            cost_calculation = state["cost_calculation"]
            finalized_assumptions = state["finalized_assumptions"]
            env_config = state["env_config"]
            
            # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«è¦‹ç©æ›¸è¡¨ç¤º
            self._display_estimation_report(cost_calculation, finalized_assumptions)
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹
            approval_result = self._get_user_approval()\n            \n            if approval_result[\"approved\"]:\n                # Excelå‡ºåŠ›å®Ÿè¡Œ\n                excel_output = self._generate_excel_output(\n                    state[\"deliverables\"],\n                    cost_calculation,\n                    finalized_assumptions,\n                    env_config\n                )\n                \n                return {\n                    **state,\n                    \"approved\": True,\n                    \"final_excel_output\": excel_output[\"file_path\"],\n                    \"excel_generation_metadata\": excel_output[\"metadata\"],\n                    \"completion_timestamp\": datetime.now().isoformat()\n                }\n            else:\n                return {\n                    **state,\n                    \"approved\": False,\n                    \"user_feedback\": approval_result[\"feedback\"],\n                    \"iteration_count\": state.get(\"iteration_count\", 0) + 1\n                }\n        except Exception as e:\n            return {\n                **state,\n                \"error\": f\"Report generation failed: {str(e)}\"\n            }\n    \n    def _display_estimation_report(self, cost_calculation: Dict, finalized_assumptions: Dict):\n        \"\"\"è¦‹ç©æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤º\"\"\"\n        print(\"\\nğŸ“Š è¦‹ç©æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼\")\n        print(\"=\" * 60)\n        \n        # æˆæœç‰©åˆ¥è¦‹ç©è¡¨ç¤º\n        print(\"ğŸ“‹ æˆæœç‰©åˆ¥è¦‹ç©:\")\n        deliverable_costs = cost_calculation['deliverable_costs']\n        for item in deliverable_costs:\n            print(f\"  {item['name']}: {item['effort_days']}äººæ—¥ â†’ {item['amount']:,}å††\")\n        \n        # æŠ€è¡“å‰ææ¡ä»¶è¡¨ç¤º\n        print(f\"\\nğŸ› ï¸ æŠ€è¡“å‰ææ¡ä»¶:\")\n        print(f\"  ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒ¬ãƒ™ãƒ«: {finalized_assumptions.get('engineer_level', 'N/A')}\")\n        print(f\"  æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: {finalized_assumptions.get('tech_stack', 'N/A')}\")\n        \n        # æ•°å€¤å‰ææ¡ä»¶\n        if 'database_tables' in finalized_assumptions:\n            print(f\"  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«: {finalized_assumptions['database_tables']}ãƒ†ãƒ¼ãƒ–ãƒ«\")\n        if 'api_endpoints' in finalized_assumptions:\n            print(f\"  APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: {finalized_assumptions['api_endpoints']}å€‹\")\n        if 'test_pages' in finalized_assumptions:\n            print(f\"  ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸: {finalized_assumptions['test_pages']}ãƒšãƒ¼ã‚¸\")\n        \n        # è²¡å‹™ã‚µãƒãƒªãƒ¼\n        summary = cost_calculation['financial_summary']\n        print(f\"\\nğŸ’° è²¡å‹™ã‚µãƒãƒªãƒ¼:\")\n        print(f\"  å°è¨ˆ: {summary['subtotal']:,}å††\")\n        print(f\"  ç¨é¡({summary['tax_rate']*100:.0f}%): {summary['tax_amount']:,}å††\")\n        print(f\"  ç·é¡: {summary['total_amount']:,}å††\")\n        print(f\"  ç·å·¥æ•°: {summary['total_effort_days']}äººæ—¥\")\n        \n        # ãƒªã‚¹ã‚¯ã‚¢ãƒ©ãƒ¼ãƒˆ\n        high_risk_items = []\n        for item in deliverable_costs:\n            if item.get('confidence_level'):\n                confidence = int(item['confidence_level'].rstrip('%'))\n                if confidence < 80:\n                    high_risk_items.append(f\"{item['name']} (ä¿¡é ¼åº¦{confidence}%)\")\n        \n        if high_risk_items:\n            print(f\"\\nâš ï¸ ãƒªã‚¹ã‚¯ã‚¢ãƒ©ãƒ¼ãƒˆ:\")\n            for item in high_risk_items:\n                print(f\"  â€¢ {item}\")\n        \n        # è³ªå•å¿œç­”ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±\n        qa_stats = finalized_assumptions.get('qa_session_stats', {})\n        if qa_stats:\n            print(f\"\\nğŸ“ è³ªå•å¿œç­”ã‚»ãƒƒã‚·ãƒ§ãƒ³:\")\n            print(f\"  è³ªå•æ•°: {qa_stats.get('total_questions', 0)}\")\n            print(f\"  å›ç­”æ•°: {qa_stats.get('answered_questions', 0)}\")\n    \n    def _get_user_approval(self) -> Dict[str, Any]:\n        \"\"\"ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹\"\"\"\n        approval = input(\"\"\"\nğŸ” è¦‹ç©æ›¸ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™:\n\nã“ã®è¦‹ç©æ›¸ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ\n1. ã¯ã„ï¼ˆYesï¼‰- Excelå‡ºåŠ›ã—ã¦çµ‚äº†\n2. ã„ã„ãˆï¼ˆNoï¼‰- ä¿®æ­£ãƒ»èª¿æ•´ãŒå¿…è¦\n\né¸æŠï¼ˆY/Nï¼‰: \"\"\").lower()\n        \n        if approval in ['y', 'yes', 'ã¯ã„', '1']:\n            return {\n                \"approved\": True,\n                \"action\": \"generate_excel\"\n            }\n        else:\n            # è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†\n            feedback = input(\"\"\"\nä¿®æ­£ã—ãŸã„é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„:\n\n1. æˆæœç‰©ã®è¿½åŠ ãƒ»å‰Šé™¤\n2. æŠ€è¡“å‰ææ¡ä»¶ã®å¤‰æ›´\n3. å·¥æ•°èª¿æ•´\n4. ä¾¡æ ¼èª¿æ•´\n5. ãã®ä»–\n\nä¿®æ­£å†…å®¹ã‚’è©³ã—ãè¨˜å…¥: \"\"\")\n            \n            return {\n                \"approved\": False,\n                \"feedback\": feedback,\n                \"action\": \"revise_estimate\"\n            }\n    \n    def _generate_excel_output(self, deliverables: List[Dict], cost_calculation: Dict, \n                              finalized_assumptions: Dict, env_config: Dict) -> Dict[str, Any]:\n        \"\"\"Excelå‡ºåŠ›ã®ç”Ÿæˆ\"\"\"\n        # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ\n        timestamp = datetime.now().strftime(\"%Y%m%d-%H%M%S\")\n        filename = f\"{timestamp}.xlsx\"\n        file_path = self.output_dir / filename\n        \n        # å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ\n        original_data = []\n        deliverable_costs = cost_calculation['deliverable_costs']\n        \n        # æˆæœç‰©ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ\n        for deliverable in deliverables:\n            # å¯¾å¿œã™ã‚‹ã‚³ã‚¹ãƒˆæƒ…å ±ã‚’æ¤œç´¢\n            cost_info = next(\n                (cost for cost in deliverable_costs if cost['name'] == deliverable['name']),\n                None\n            )\n            \n            if cost_info:\n                original_data.append({\n                    'A': deliverable['name'],\n                    'B': deliverable['description'],\n                    'C': cost_info['effort_days'],\n                    'D': cost_info['amount']\n                })\n        \n        # DataFrameä½œæˆ\n        df = pd.DataFrame(original_data)\n        \n        # è¨€èªè¨­å®šã«å¿œã˜ãŸãƒ˜ãƒƒãƒ€ãƒ¼\n        if env_config.get('language') == 'ja':\n            df.columns = ['æˆæœç‰©å', 'èª¬æ˜', 'äºˆæƒ³å·¥æ•°(äººæ—¥)', f'é‡‘é¡({env_config.get(\"currency\", \"JPY\")})']\n        else:\n            df.columns = ['Deliverable', 'Description', 'Effort (Person-Days)', f'Amount ({env_config.get(\"currency\", \"JPY\")})']\n        \n        # è²¡å‹™ã‚µãƒãƒªãƒ¼è¡Œã‚’è¿½åŠ \n        summary = cost_calculation['financial_summary']\n        \n        # ç©ºè¡Œè¿½åŠ \n        df.loc[len(df)] = ['', '', '', '']\n        \n        # ã‚µãƒãƒªãƒ¼è¡Œè¿½åŠ \n        if env_config.get('language') == 'ja':\n            df.loc[len(df)] = ['å°è¨ˆ', '', summary['total_effort_days'], summary['subtotal']]\n            df.loc[len(df)] = [f'ç¨é¡({summary[\"tax_rate\"]*100:.0f}%)', '', '', summary['tax_amount']]\n            df.loc[len(df)] = ['ç·é¡', '', '', summary['total_amount']]\n            df.loc[len(df)] = ['', '', '', '']\n            df.loc[len(df)] = ['ã€è¦‹ç©å‰ææ¡ä»¶ã€‘', '', '', '']\n        else:\n            df.loc[len(df)] = ['Subtotal', '', summary['total_effort_days'], summary['subtotal']]\n            df.loc[len(df)] = [f'Tax ({summary[\"tax_rate\"]*100:.0f}%)', '', '', summary['tax_amount']]\n            df.loc[len(df)] = ['Total', '', '', summary['total_amount']]\n            df.loc[len(df)] = ['', '', '', '']\n            df.loc[len(df)] = ['ã€Estimation Assumptionsã€‘', '', '', '']\n        \n        # å‰ææ¡ä»¶ã‚’è¿½åŠ \n        assumptions_to_add = [\n            ('ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒ¬ãƒ™ãƒ«' if env_config.get('language') == 'ja' else 'Engineer Level', \n             finalized_assumptions.get('engineer_level', 'N/A')),\n            ('äººæ—¥å˜ä¾¡' if env_config.get('language') == 'ja' else 'Daily Rate', \n             f\"{env_config.get('daily_rate', 0):,} ({env_config.get('currency', 'JPY')})\"),\n            ('æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯' if env_config.get('language') == 'ja' else 'Tech Stack', \n             finalized_assumptions.get('tech_stack', 'N/A')),\n        ]\n        \n        # æ•°å€¤å‰ææ¡ä»¶\n        if 'database_tables' in finalized_assumptions:\n            assumptions_to_add.append((\n                'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«' if env_config.get('language') == 'ja' else 'Database Tables',\n                f\"{finalized_assumptions['database_tables']}ãƒ†ãƒ¼ãƒ–ãƒ«æƒ³å®š\" if env_config.get('language') == 'ja' else f\"{finalized_assumptions['database_tables']} tables assumed\"\n            ))\n        \n        if 'api_endpoints' in finalized_assumptions:\n            assumptions_to_add.append((\n                'APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ' if env_config.get('language') == 'ja' else 'API Endpoints',\n                f\"{finalized_assumptions['api_endpoints']}ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæƒ³å®š\" if env_config.get('language') == 'ja' else f\"{finalized_assumptions['api_endpoints']} endpoints assumed\"\n            ))\n        \n        if 'test_pages' in finalized_assumptions:\n            assumptions_to_add.append((\n                'ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸' if env_config.get('language') == 'ja' else 'Test Pages',\n                f\"{finalized_assumptions['test_pages']}ãƒšãƒ¼ã‚¸æƒ³å®š\" if env_config.get('language') == 'ja' else f\"{finalized_assumptions['test_pages']} pages assumed\"\n            ))\n        \n        # å‰ææ¡ä»¶ã‚’è¿½åŠ \n        for label, value in assumptions_to_add:\n            df.loc[len(df)] = [label, value, '', '']\n        \n        # Excelãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ\n        with pd.ExcelWriter(file_path, engine='openpyxl') as writer:\n            df.to_excel(writer, index=False, sheet_name='è¦‹ç©æ›¸')\n            \n            # ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã®å–å¾—ã¨æ›¸å¼è¨­å®š\n            worksheet = writer.sheets['è¦‹ç©æ›¸']\n            \n            # åˆ—å¹…ã®èª¿æ•´\n            worksheet.column_dimensions['A'].width = 25\n            worksheet.column_dimensions['B'].width = 50\n            worksheet.column_dimensions['C'].width = 15\n            worksheet.column_dimensions['D'].width = 15\n            \n            # æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®è¨­å®šï¼ˆé‡‘é¡åˆ—ï¼‰\n            for row in range(2, len(df) + 2):\n                if isinstance(df.iloc[row-2, 3], (int, float)) and df.iloc[row-2, 3] != '':\n                    worksheet.cell(row=row, column=4).number_format = '#,##0'\n        \n        print(f\"\\nâœ… è¦‹ç©æ›¸ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ: {file_path}\")\n        \n        return {\n            \"file_path\": str(file_path),\n            \"filename\": filename,\n            \"metadata\": {\n                \"generation_timestamp\": datetime.now().isoformat(),\n                \"total_rows\": len(df),\n                \"data_rows\": len(deliverables),\n                \"summary_rows\": len(df) - len(deliverables),\n                \"language\": env_config.get('language', 'ja'),\n                \"currency\": env_config.get('currency', 'JPY')\n            }\n        }